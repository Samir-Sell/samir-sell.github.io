const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-C2mNIqIY.js","assets/index-MBf2dn39.js","assets/index-DZndqy9Z.css","assets/quat-CJ8rynPP.js","assets/quatf64-aQ5IuZRd.js","assets/BufferView-DbmJqxmi.js","assets/resourceUtils-D01uTYfQ.js"])))=>i.map(i=>d[i]);
import{l6 as me,l7 as de,ju as G,dU as ee,iU as W,l8 as te,f2 as K,as as re,H as pe,f as se,o as he,gX as oe,kH as L,b as xe,_ as ge,eL as ye,eM as be,dy as H,eO as N,dx as Te,l9 as Q,dz as we,dL as ve,eB as $e,ej as Me,la as z,lb as Ae,hs as Re,ht as X,hu as Be}from"./index-MBf2dn39.js";import{a as Se}from"./devEnvironmentUtils-CnNDiFMM.js";import{m as ne,n as j}from"./OutputColorHighlightOID.glsl-B891PYAI.js";import{o as ae,T as ie,g as Pe,M as Ee,O as Ie,V as Oe}from"./BufferView-DbmJqxmi.js";import{r as _e,n as Ce,d as J,l as Y}from"./vec3-0XSdc2yf.js";import{o as Ue,d as Z}from"./vec4-vZoWQHkE.js";import{l as Fe,o as je,n as ke}from"./indexUtils-BGGt_1o7.js";import{t as k}from"./resourceUtils-D01uTYfQ.js";import{u as Le}from"./memoryEstimations-BPPA_w8H.js";import{t as Ve}from"./NestedMap-DI2--xdt.js";import{A as De}from"./Indices-BpMW4q8F.js";import{t as qe}from"./requestImageUtils-BHT-P2J3.js";import{t as _}from"./orientedBoundingBox-DEJPi3ue.js";import{M as le}from"./Texture-y8-8wIO1.js";import{P as V,n as Ge,o as He,s as ze,t as We}from"./DefaultMaterial-sW8DmwNo.js";function U(r){if(r==null)return null;const e=r.offset!=null?r.offset:me,o=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:de,u=G(1,0,0,0,1,0,e[0],e[1],1),i=G(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),n=G(s[0],0,0,0,s[1],0,0,0,1),a=ee();return W(a,i,n),W(a,u,a),a}class Ke{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Ne{constructor(e,o,s){this.name=e,this.lodThreshold=o,this.pivotOffset=s,this.stageResources=new Ke,this.numberOfVertices=0}}const S=()=>he.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class Qe{constructor(e,o,s){this.resource=e,this.textures=o,this.usedMemory=s}}async function Xe(r,e){const o=await Je(r,e),s=await rt(o.textureDefinitions??{},e);let u=0;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i];u+=n!=null&&n.image?n.image.width*n.image.height*4:0}return new Qe(o,s,u+Le(o))}async function Je(r,e){const o=e==null?void 0:e.streamDataRequester;if(o)return Ye(r,o,e);const s=await re(pe(r,e));if(s.ok===!0)return s.value.data;se(s.error),ue(s.error)}async function Ye(r,e,o){const s=await re(e.request(r,0,o));if(s.ok===!0)return s.value;se(s.error),ue(s.error.details.url)}function ue(r){throw new xe("",`Request for object resource failed: ${r}`)}function Ze(r){const e=r.params,o=e.topology;let s=!0;switch(e.vertexAttributes||(S().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=e.faces;if(i){if(e.vertexAttributes)for(const n in e.vertexAttributes){const a=i[n];a!=null&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(S().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),s=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(S().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),s=!1)):(S().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),s=!1)}}else S().warn("Indexed geometries must specify faces"),s=!1;break}default:S().warn(`Unsupported topology '${o}'`),s=!1}r.params.material||(S().warn("Geometry requires material"),s=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(S().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function et(r,e){var g,m;const o=new Array,s=new Array,u=new Array,i=new Ve,n=r.resource,a=te.parse(n.version||"1.0","wosr");ot.validate(a);const f=n.model.name,t=n.model.geometries,l=n.materialDefinitions??{},c=r.textures;let d=0;const p=new Map;for(let b=0;b<t.length;b++){const y=t[b];if(!Ze(y))continue;const v=st(y),w=y.params.vertexAttributes,M=[],A=h=>{if(y.params.topology==="PerAttributeArray")return null;const T=y.params.faces;for(const x in T)if(x===h)return T[x].values;return null},P=w.position,F=P.values.length/P.valuesPerElement;for(const h in w){const T=w[h],x=T.values,q=A(h)??De(F);M.push([h,new _(x,q,T.valuesPerElement,!0)])}const $=v.texture,R=c&&c[$];if(R&&!p.has($)){const{image:h,parameters:T}=R,x=new le(h,T);s.push(x),p.set($,x)}const C=p.get($),E=C?C.id:void 0,I=v.material;let B=i.get(I,$);if(B==null){const h=l[I.slice(I.lastIndexOf("/")+1)].params;h.transparency===1&&(h.transparency=0);const T=R?ce(R.alphaChannelUsage):void 0,x={ambient:K(h.diffuse),diffuse:K(h.diffuse),opacity:1-(h.transparency||0),textureAlphaMode:T,textureAlphaCutoff:.33,textureId:E,doubleSided:!0,cullFace:0,colorMixMode:h.externalColorMixMode||"tint",textureAlphaPremultiplied:(R==null?void 0:R.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(x,e.materialParameters),B=new V(x,e),i.set(I,$,B)}u.push(B);const D=new ne(B,M);d+=((m=(g=M.find(h=>h[0]==="position"))==null?void 0:g[1])==null?void 0:m.indices.length)??0,o.push(D)}return{engineResources:[{name:f,stageResources:{textures:s,materials:u,geometries:o},pivotOffset:n.model.pivotOffset,numberOfVertices:d,lodThreshold:null}],referenceBoundingBox:tt(o)}}function tt(r){const e=oe();return r.forEach(o=>{const s=o.boundingInfo;s!=null&&(L(e,s.bbMin),L(e,s.bbMax))}),e}async function rt(r,e){const o=new Array;for(const i in r){const n=r[i],a=n.images[0].data;if(!a){S().warn("Externally referenced texture data is not yet supported");continue}const f=n.encoding+";base64,"+a,t="/textureDefinitions/"+i,l=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:ce(l)!==1},d=e!=null&&e.disableTextures?Promise.resolve(null):qe(f,e);o.push(d.then(p=>({refId:t,image:p,parameters:c,alphaChannelUsage:l})))}const s=await Promise.all(o),u={};for(const i of s)u[i.refId]=i;return u}function ce(r){switch(r){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function st(r){const e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const ot=new te(1,2,"wosr");async function nt(r,e){var c;const o=fe(Se(r));if(o.fileType==="wosr"){const d=await(e.cache?e.cache.loadWOSR(o.url,e):Xe(o.url,e)),{engineResources:p,referenceBoundingBox:g}=et(d,e);return{lods:p,referenceBoundingBox:g,isEsriSymbolResource:!1,isWosr:!0}}let s;if(e.cache)s=await e.cache.loadGLTF(o.url,e,!!e.usePBR);else{const{loadGLTF:d}=await ge(()=>import("./loader-C2mNIqIY.js"),__vite__mapDeps([0,1,2,3,4,5,6]));s=await d(new Fe(e.streamDataRequester),o.url,e,e.usePBR)}const u=(c=s.model.meta)==null?void 0:c.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&u!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ct(s,u));const n=!!e.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:ze}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:We},f={...e.materialParameters,treeRendering:i},{engineResources:t,referenceBoundingBox:l}=at(s,a,f,e,o.specifiedLodIndex,i);return{lods:t,referenceBoundingBox:l,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function fe(r){const e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function at(r,e,o,s,u,i){const n=r.model,a=new Array,f=new Map,t=new Map,l=n.lods.length,c=oe();return n.lods.forEach((d,p)=>{const g=s.skipHighLods===!0&&(l>1&&p===0||l>3&&p===1)||s.skipHighLods===!1&&u!=null&&p!==u;if(g&&p!==0)return;const m=new Ne(d.name,d.lodThreshold,[0,0,0]);d.parts.forEach(b=>{const y=g?new V({},s):it(n,b,m,e,o,f,t,s,i),{geometry:v,vertexCount:w}=lt(b,y??new V({},s)),M=v.boundingInfo;M!=null&&p===0&&(L(c,M.bbMin),L(c,M.bbMax)),y!=null&&(m.stageResources.geometries.push(v),m.numberOfVertices+=w)}),g||a.push(m)}),{engineResources:a,referenceBoundingBox:c}}function it(r,e,o,s,u,i,n,a,f){var w,M;const t=r.materials.get(e.material);if(t==null)return null;const{normal:l,color:c,texCoord0:d,tangent:p}=e.attributes,g=e.material+(l?"_normal":"")+(c?"_color":"")+(d?"_texCoord0":"")+(p?"_tangent":""),m=e.attributes.texCoord0!=null,b=e.attributes.normal!=null,y=ut(t.alphaMode);if(!i.has(g)){if(m){const E=(B,D=!1,h=!1)=>{if(B!=null&&!n.has(B)){const T=r.textures.get(B);if(T){const x=T.data,q=D&&!k(x)?a.compressionOptions:void 0;n.set(B,new le(k(x)?x.data:x,{...T.parameters,preMultiplyAlpha:!k(x)&&h,encoding:k(x)?x.encoding:void 0,compressionOptions:q}))}}},I=y!==1&&!f;E(t.colorTexture,I,y!==1),E(t.normalTexture),E(t.occlusionTexture,!0),E(t.emissiveTexture),E(t.metallicRoughnessTexture,!0)}const A=z(t.color[0]),P=z(t.color[1]),F=z(t.color[2]),$=t.colorTexture!=null&&m?n.get(t.colorTexture):null,R=Ge(t),C=((w=t.normalTextureTransform)==null?void 0:w.scale)!=null?(M=t.normalTextureTransform)==null?void 0:M.scale:Ae;i.set(g,new V({...s,customDepthTest:1,textureAlphaMode:y,textureAlphaCutoff:t.alphaCutoff,diffuse:[A,P,F],ambient:[A,P,F],opacity:t.alphaMode==="OPAQUE"?1:t.opacity,doubleSided:t.doubleSided,doubleSidedType:"winding-order",cullFace:t.doubleSided?0:2,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:b?0:2,castShadows:!0,receiveShadows:t.receiveShadows,receiveAmbientOcclusion:t.receiveAmbientOcclusion,textureId:$!=null?$.id:void 0,colorMixMode:t.colorMixMode,normalTextureId:t.normalTexture!=null&&m?n.get(t.normalTexture).id:void 0,textureAlphaPremultiplied:$!=null&&!!$.parameters.preMultiplyAlpha,occlusionTextureId:t.occlusionTexture!=null&&m?n.get(t.occlusionTexture).id:void 0,emissiveTextureId:t.emissiveTexture!=null&&m?n.get(t.emissiveTexture).id:void 0,metallicRoughnessTextureId:t.metallicRoughnessTexture!=null&&m?n.get(t.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],mrrFactors:R?He:[t.metallicFactor,t.roughnessFactor,s.mrrFactors[2]],isSchematic:R,colorTextureTransformMatrix:U(t.colorTextureTransform),normalTextureTransformMatrix:U(t.normalTextureTransform),scale:[C[0],C[1]],occlusionTextureTransformMatrix:U(t.occlusionTextureTransform),emissiveTextureTransformMatrix:U(t.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:U(t.metallicRoughnessTextureTransform),...u},a))}const v=i.get(g);if(o.stageResources.materials.push(v),m){const A=P=>{P!=null&&o.stageResources.textures.push(n.get(P))};A(t.colorTexture),A(t.normalTexture),A(t.occlusionTexture),A(t.emissiveTexture),A(t.metallicRoughnessTexture)}return v}function lt(r,e){const o=r.attributes.position.count,s=je(r.indices||o,r.primitiveType),u=j(3*o),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;_e(u,i,r.transform,3,n);const a=[["position",new _(u,s,3,!0)]];if(r.attributes.normal!=null){const t=j(3*o),{typedBuffer:l,typedBufferStride:c}=r.attributes.normal;Re(O,r.transform),Ce(t,l,O,3,c),X(O)&&J(t,t),a.push(["normal",new _(t,s,3,!0)])}if(r.attributes.tangent!=null){const t=j(4*o),{typedBuffer:l,typedBufferStride:c}=r.attributes.tangent;Be(O,r.transform),Ue(t,l,O,4,c),X(O)&&J(t,t,4),a.push(["tangent",new _(t,s,4,!0)])}if(r.attributes.texCoord0!=null){const t=j(2*o),{typedBuffer:l,typedBufferStride:c}=r.attributes.texCoord0;ke(t,l,2,c),a.push(["uv0",new _(t,s,2,!0)])}const f=r.attributes.color;if(f!=null){const t=new Uint8Array(4*o);f.elementCount===4?f instanceof ie?Z(t,f,1,255):(f instanceof Pe||f instanceof Ee)&&Z(t,f,1/255,255):(t.fill(255),f instanceof ae?Y(t,f.typedBuffer,1,255,4,f.typedBufferStride):(r.attributes.color instanceof Ie||r.attributes.color instanceof Oe)&&Y(t,f.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push(["color",new _(t,s,4,!0)])}return{geometry:new ne(e,a),vertexCount:o}}const O=ee();function ut(r){switch(r){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function ct(r,e){for(let o=0;o<r.model.lods.length;++o){const s=r.model.lods[o];for(const u of s.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,a=n.count,f=H(),t=H(),l=H(),c=new Float32Array(4*a),d=new Float32Array(3*a),p=ye(be(),u.transform);let g=0,m=0;for(let b=0;b<a;b++){n.getVec(b,t),i.getVec(b,f),N(t,t,u.transform),Te(l,t,e.center),Q(l,l,e.radius);const y=l[2],v=we(l),w=Math.min(.45+.55*v*v,1)**Me;Q(l,l,e.radius),p!==null&&N(l,l,p),ve(l,l),o+1!==r.model.lods.length&&r.model.lods.length>1&&$e(l,l,f,y>-1?.2:Math.min(-4*y-3.8,1)),d[g]=l[0],d[g+1]=l[1],d[g+2]=l[2],g+=3,c[m]=w,c[m+1]=w,c[m+2]=w,c[m+3]=1,m+=4}u.attributes.normal=new ae(d.buffer),u.attributes.color=new ie(c.buffer)}}}const Rt=Object.freeze(Object.defineProperty({__proto__:null,fetch:nt,parseUrl:fe},Symbol.toStringTag,{value:"Module"}));export{Rt as o,U as s,nt as z};
