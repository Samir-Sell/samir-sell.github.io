import{bK as _,bL as K,bk as A,bM as T,bN as k,bO as V,bP as w,bj as N,bQ as W,m as B,G as J,bR as X,bh as F,bS as Y,bT as R,ag as ee}from"./index-DalZQxea.js";import{x as U,U as te}from"./utils-CFjJWc1n.js";const ne="esri.widgets.Feature.support.featureUtils",h=()=>B.getLogger(ne),re=/href=(""|'')/gi,ie=/(\{([^{\r\n]+)\})/g,ae=/'/g,j=/^\s*expression\//i,oe=/(\n)/gi,le=/[\u00A0-\u9999<>&]/gim,se=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,ue=/^(?:mailto:|tel:)/,M="relationships/",v=K("short-date-short-time");function Ue(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function je({type:e,value:t,event:n}){try{return typeof t=="function"?t(n):await t}catch(r){return void h().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t})}}function Me(e=""){if(e)return!ue.test(e.trim().toLowerCase())}function S(e){return!!e&&j.test(e)}function fe(e,t){if(!t||!S(t)||!e)return;const n=t.replace(j,"").toLowerCase();return e.find(({name:r})=>r.toLowerCase()===n)}function D({fieldInfo:e,graphic:t}){return!(!(e!=null&&e.fieldName)||S(e.fieldName)||C(e.fieldName)||t!=null&&t.isAggregate||t!=null&&t.popupTemplate)}function Se({expressionInfos:e,fieldInfo:t,graphic:n,isContentFieldInfos:r,layer:a}){if(!(t!=null&&t.fieldName))return null;const o=fe(e,t.fieldName);if(o)return o.title||null;if(T(a)&&D({fieldInfo:t,graphic:n})){const i=a.getFieldAlias(t.fieldName);return r?t.label||i||t.fieldName:i||t.fieldName}return t.label||t.fieldName}function de({fieldInfo:e,isContentFieldInfos:t,layer:n}){var r;if(!(e!=null&&e.fieldName))return null;if(T(n)){const a=n.popupTemplate||n.fieldConfigurations?(r=n.getFieldConfiguration(e.fieldName))==null?void 0:r.fieldFormat:W(e,n.getField(e.fieldName));return t&&e.fieldFormat||a}return null}function ce(e,t){const n=t.get(e.toLowerCase());return`{${(n==null?void 0:n.fieldName)||e}}`}function pe(e){return e.replaceAll(re,"")}function G(e,t){const n=L(t,e);return n?n.name:e}function De(e,t){return e&&e.map(n=>G(n,t))}function L(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function O(e){return`${e}`.trim()}function Ge({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:a,fieldInfoMap:o}){return r?ye({formattedAttributes:t,template:Fe(r,{...t,...a,...e},n),fieldInfoMap:o}):""}function ye({formattedAttributes:e,template:t,fieldInfoMap:n}){return O(pe(F(F(t,r=>ce(r,n)),e)))}function me(e,t,n=!1){const r=t[e];if(typeof r=="string"){const a="%27",o=(n?encodeURIComponent(r):r).replaceAll(ae,a);t[e]=o}}function be(e,t=!1){const n={...e};return Object.keys(n).forEach(r=>me(r,n,t)),n}function Ie(e,t,n){const r=(t=O(t))&&!t.startsWith("{");return F(e,be(n,r||!1))}function ge(e,t){return e.replaceAll(ie,(n,r,a)=>{const o=L(t,a);return o?`{${o.name}}`:r})}function Fe(e,t,n){const r=ge(e,n);return r&&r.replaceAll(se,(a,o,i)=>Ie(a,o||i,t))}function he(e,t){var r;const n=((r=t==null?void 0:t.fieldFormat)==null?void 0:r.type)==="number"||(t==null?void 0:t.format)&&t.format.dateFormat==null&&(t.format.places!=null||t.format.digitSeparator!=null);if(typeof e=="string"&&n){const a=Number(e);if(!isNaN(a))return a}return e}function Te(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="subtype-group"||e.type==="subtype-sublayer"||e.type==="sublayer")&&"when"in e}function we(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function z(e){return Te(e)&&we(e)}function Oe(e){return!(!(e&&typeof e=="object"&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||e.type!=="feature"&&e.type!=="subtype-group"&&e.type!=="subtype-sublayer"&&e.type!=="sublayer"||!("when"in e))&&(e.type==="subtype-sublayer"&&"parent"in e&&e.parent&&typeof e.parent=="object"?"globalIdField"in e.parent:"globalIdField"in e)}function ze(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&z(e.sourceLayer)}function Ne(e,t){const{fieldInfos:n,fieldName:r,graphic:a,isContentFieldInfos:o,layer:i,preventPlacesFormatting:u,timeZone:l}=t,s=Ce(n,r),c=L(i,r),p=T(i)&&D({fieldInfo:s,graphic:a}),f=p?null:s==null?void 0:s.format,d=p?de({fieldInfo:s,layer:i,isContentFieldInfos:o}):null,b=(d==null?void 0:d.type)==="number";if(s&&!k(r)){const m=c==null?void 0:c.type,I=(d==null?void 0:d.type)==="date-time",q=f==null?void 0:f.dateFormat;if(m==="date"||m==="date-only"||m==="time-only"||m==="timestamp-offset"||I||q)return U(e,{format:I?void 0:q,fieldFormat:I?d:void 0,fieldType:m,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:l,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}})}if(typeof e=="string"&&k(r)&&f)return Le(e,f);if(typeof(e=he(e,{format:b?void 0:f,fieldFormat:b?d:void 0}))=="string"||e==null||f==null&&d==null)return Q(e);const x=b?V(d):f?w(f):void 0;return N(e,u?{...x,minimumFractionDigits:0,maximumFractionDigits:20}:x)}function Le(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?g(e,",",", ",t):e.includes(";")?g(e,";","; ",t):e.includes(" ")?g(e," "," ",t):N(Number(e),w(t))}function g(e,t,n,r){return e.trim().split(t).map(a=>N(Number(a),w(r))).join(n)}function Ce(e,t){if(e!=null&&e.length&&t)return e.find(n=>{var r;return((r=n.fieldName)==null?void 0:r.toLowerCase())===t.toLowerCase()})}function xe({fieldName:e,graphic:t,layer:n}){if(C(e)||!n||typeof n.getFeatureType!="function")return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const a=n.getFeatureType(t);return a?a.name:null}function qe({fieldName:e,value:t,graphic:n,layer:r}){if(C(e)||!r||typeof r.getFieldDomain!="function")return null;const a=n&&r.getFieldDomain(e,{feature:n,excludeImpliedDomains:ee("esri-widget-legacy-field-domain-calculation")});return a&&a.type==="coded-value"?a.getName(t):null}function Qe(e,t,n,r){const{creatorField:a,creationDateField:o,editorField:i,editDateField:u}=e;if(!t)return;const l=_(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r))&&!!r.datesInUnknownTimezone,n,v,"date"),s={...v,...l},c=t[u];if(typeof c=="number"){const f=t[i];return{type:"edit",date:A(c,s),user:f}}const p=t[o];if(typeof p=="number"){const f=t[a];return{type:"create",date:A(p,s),user:f}}return null}function Pe(e,t){const n=new Map;if(!e)return n;for(const r of e){if(!r.fieldName)continue;const a=G(r.fieldName,t);r.fieldName=a,n.set(a.toLowerCase(),r)}return n}function He(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)&&r.forEach(a=>{if(a.type==="fields"){const o=a==null?void 0:a.fieldInfos;o&&t.push(...o)}}),t}function _e(e){return e.replaceAll(le,t=>`&#${t.charCodeAt(0)};`)}function Q(e){return typeof e=="string"?e.replaceAll(oe,'<br class="esri-text-new-line" />'):e}function P(e){var f;const{fieldInfoMap:t,fieldInfos:n,fieldName:r,graphic:a,isContentFieldInfos:o,layer:i,timeZone:u,value:l}=e;if(l==null)return"";const s=qe({fieldName:r,value:l,graphic:a,layer:i});if(s)return s;const c=xe({fieldName:r,graphic:a,layer:i});if(c)return c;if(t.get(r.toLowerCase()))return Ne(l,{fieldInfos:n||Array.from(t.values()),fieldName:r,graphic:a,isContentFieldInfos:o,layer:i,timeZone:u});const p=(f=i==null?void 0:i.fieldsIndex)==null?void 0:f.get(r);return p&&(te(p)||Y(p))?U(l,{fieldType:p.type,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}}):Q(l)}function Ke({attributes:e,fieldInfoMap:t,fieldInfos:n,graphic:r,isContentFieldInfos:a,layer:o,relatedInfos:i,timeZone:u}){const l={};return i==null||i.forEach(s=>$e({attributes:l,relatedInfo:s,fieldInfoMap:t,fieldInfos:n,layer:o,timeZone:u})),e&&Object.keys(e).forEach(s=>{const c=e[s];l[s]=P({fieldInfoMap:t,fieldInfos:n,fieldName:s,graphic:r,isContentFieldInfos:a,layer:o,timeZone:u,value:c})}),l}async function Ae(e,t){var c,p;const{layer:n,graphic:r,outFields:a,objectIds:o,returnGeometry:i,spatialReference:u}=e,l=o[0];if(typeof l!="number"&&typeof l!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",d={layer:n,graphic:r,objectId:l,requiredFields:a};return h().warn(f,d),null}if(!((p=(c=J(n))==null?void 0:c.operations)!=null&&p.supportsQuery)){const f="The specified layer cannot be queried. The following fields will not be available.",d={layer:n,graphic:r,requiredFields:a,returnGeometry:i};return h().warn(f,d),null}const s=n.createQuery();return s.objectIds=o,s.outFields=a!=null&&a.length?a:[n.objectIdField],s.returnGeometry=!!i,s.returnZ=!!i,s.returnM=!!i,s.outSpatialReference=u,(await n.queryFeatures(s,t)).features[0]}async function ke(e){var r;if(!((r=e.expressionInfos)!=null&&r.length))return!1;const t=await R(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}async function ve(e){var r;if(!((r=e.expressionInfos)!=null&&r.length))return!1;const t=await R(),{arcadeUtils:{requiresTrack:n}}=t;return n(e)}async function Ve({graphic:e,popupTemplate:t,layer:n,spatialReference:r},a){var d;if(!n||!t||(typeof n.load=="function"&&await n.load(a),!e.attributes))return;const o=n.objectIdField,i=e.attributes[o];if(i==null)return;const u=[i],l=new Set(await t.getRequiredFields(n.fieldsIndex));((d=n.timeInfo)==null?void 0:d.trackIdField)==null||l.has(n.timeInfo.trackIdField)||await ve(t)&&l.add(n.timeInfo.trackIdField);const s=X(e,l),c=s?[]:l.has(o)?[...l]:[...l,o],p=t.returnGeometry||await ke(t);if(s&&!p)return;const f=await Ae({layer:n,graphic:e,outFields:c,objectIds:u,returnGeometry:p,spatialReference:r},a);f&&(f.geometry&&(e.geometry=f.geometry),f.attributes&&(e.attributes={...e.attributes,...f.attributes}))}function C(e=""){return!!e&&e.includes(M)}function Ze(e){return e?`${M}${e.layerId}/${e.fieldName}`:""}function Z({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:a,layer:o,timeZone:i}){e&&t&&n&&Object.keys(t.attributes).forEach(u=>{const l=Ze({layerId:n.relation.id.toString(),fieldName:u}),s=t.attributes[u];e[l]=P({fieldName:l,fieldInfos:r,fieldInfoMap:a,layer:o,value:s,graphic:t,timeZone:i})})}function $e({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:o}){var i,u;e&&t&&((i=t.relatedFeatures)==null||i.forEach(l=>Z({attributes:e,graphic:l,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:o})),(u=t.relatedStatsFeatures)==null||u.forEach(l=>Z({attributes:e,graphic:l,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:o})))}const $=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},H=({layer:e,method:t,query:n,definitionExpression:r})=>{var i,u;if(!((u=(i=e.capabilities)==null?void 0:i.query)!=null&&u.supportsCacheHint)||t==="attachments")return;const a=n.where!=null?n.where:null,o=n.geometry!=null?n.geometry:null;$(r)||$(a)||(o==null?void 0:o.type)==="extent"||n.resultType==="tile"||(n.cacheHint=!0)},We=({query:e,layer:t,method:n})=>{H({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},Be=({queryPayload:e,layer:t,method:n})=>{H({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function Je(e,t,n){var r,a;return e&&t&&n?t.type==="sublayer"?y({layers:(r=t.layer)==null?void 0:r.allSublayers,map:e,relatedLayer:t,relationship:n})||y({layers:(a=t.layer)==null?void 0:a.subtables,map:e,relatedLayer:t,relationship:n}):y({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||y({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function Xe(e,t){var n;return e&&"utilityNetworks"in e&&t?(n=e.utilityNetworks)==null?void 0:n.find(r=>r.isUtilityLayer(t)):null}function E(e,t){return e==null?void 0:e.allTables.find(n=>{var r;return n.type==="feature"&&n.layerId===t.id&&n.url===((r=t.layer)==null?void 0:r.url)})}function y({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:a}){var o;if(!a)return null;for(const i of a){if(i.type==="map-image"){const l=y({layers:i.sublayers,map:e,relatedLayer:r,relationship:t})||y({layers:i.subtables,map:e,relatedLayer:r,relationship:t});if(l)return l;continue}if(!z(i))continue;if(r.type==="sublayer"){if(i!==r&&i.id===n)return i.isTable?E(e,i):i;continue}const u=r.type==="scene"&&r.associatedLayer?r.associatedLayer.url:r.url;if(!u)return null;if(i.type!=="sublayer"){if(i!==r&&i.url===u&&i.layerId===n)return i}else if(i!==r&&((o=i.layer)==null?void 0:o.url)===u&&i.id===n)return i.isTable?E(e,i):i}return null}export{Q as applyTextFormattingHTML,Pe as createFieldInfoMap,Je as findRelatedLayer,Xe as findUtilityNetwork,ge as fixTokens,Ke as formatAttributes,Qe as formatEditInfo,Ne as formatValueToFieldInfo,He as getAllFieldInfos,de as getFieldFormat,Ce as getFieldInfo,Se as getFieldInfoLabel,G as getFixedFieldName,De as getFixedFieldNames,Ue as getSourceLayer,je as graphicCallback,_e as htmlEntities,Oe as isAssociatedFeatureSupportedLayer,S as isExpressionField,Te as isFeatureSupportedLayer,ze as isGraphicForRelatableFeatureSupportedLayer,z as isRelatableFeatureSupportedLayer,we as isRelatableLayer,C as isRelatedField,D as isSupportedContext,We as preLayerQueryCallback,Be as preRequestCallback,Ae as querySourceLayer,Ve as queryUpdatedFeature,Me as shouldOpenInNewTab,ye as substituteAttributes,Ge as substituteFieldsInLinksAndAttributes};
